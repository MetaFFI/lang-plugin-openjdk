package main

const GuestHeaderTemplate = `
// Code generated by OpenFFI. Modify only in marked places.
// Guest code for {{.IDLFilenameWithExtension}}
`

const GuestPackage = `package openffi;
`

const GuestImportsTemplate = `
import java.io.*;
import com.google.protobuf.*;
import java.util.*;
{{range $mindex, $i := .Imports}}
import {{$i}}.*;{{end}}
`

const GuestFunctionXLLRTemplate = `
{{$idlFilename := .IDLFilename}}
{{range $mindex, $m := .Modules}}
// Code to call foreign functions in module {{$m.Name}}
public final class {{$m.Name}}
{
	{{range $findex, $f := $m.Functions}}
	// Call to foreign {{.PathToForeignFunction.function}}{{$ReturnValuesLength := len $f.ReturnValues}}{{$ParametersLength := len $f.Parameters}}
	public static CallResult EntryPoint_{{$f.PathToForeignFunction.function}}(byte[] params) throws InvalidProtocolBufferException, OpenFFIException, Exception
	{
		{{if gt $ParametersLength 0}}// deserialize from protobuf
		{{$idlFilename}}Proto.{{$f.ParametersType}} req = {{$idlFilename}}Proto.{{$f.ParametersType}}.parseFrom(params);{{end}}

		// call function
		{{if eq $ReturnValuesLength 0}}{{else if gt $ReturnValuesLength 1}}{{$f.ReturnValuesType}} res = {{else}}{{$elem := index $f.ReturnValues 0}}{{ToJavaType $elem.Type}} {{$elem.Name}} = {{end}}{{$f.PathToForeignFunction.class}}.{{$f.PathToForeignFunction.function}}({{range $index, $elem := $f.Parameters}}{{if $index}}, {{end}}{{ToParamCall "req" $elem}}{{end}});

		CallResult cr = new CallResult();

		{{if eq $ReturnValuesLength 0}}
		return cr;
		{{else if gt $ReturnValuesLength 1}}
		cr.out_ret = res.build().toByteArray();
		return cr;
		{{else}}{{$elem := index $f.ReturnValues 0}}
		// serialize {{$f.ReturnValuesType}} to protobuf
        {{$idlFilename}}Proto.{{$f.ReturnValuesType}} proto{{$f.ReturnValuesType}} =
                {{$idlFilename}}Proto.{{$f.ReturnValuesType}}.newBuilder()
                {{if $elem.IsArray}}.addAll{{Title $elem.Name}}(Arrays.asList({{$elem.Name}})){{else}}.set{{Title $elem.Name}}({{$elem.Name}}){{end}}
                .build();
        cr.out_ret = proto{{$f.ReturnValuesType}}.toByteArray();
        return cr;
		{{end}}
	}
	{{end}}

}
{{end}}
`
